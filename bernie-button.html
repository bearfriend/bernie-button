<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="bower_components/polymer/polymer.html">

<dom-module id="bernie-button">
  <template>
    <style>
      :host {
        display: block;
        min-width: 320px;
        max-width: 1000px;
      }

      #container {
        display: block;
        padding: 1em;
        background-color: #007DDA;
        color: #fff;
        text-align: center;
        font-family: sans-serif;
      }

      footer {
        text-align: right;
      }

      a, .link {
        color: #97c5ed;
      }

      a:hover, .link:hover {
        color: #fff;
      }

      h1 {
        margin: 0;
      }

      button {
        border-radius: .2em;
        padding: .5em 1em;
        background-color: #F85A57;
        color: #fff;
        margin: 1.5em;
        border: 0px;
        outline: none;
        position: relative;
        cursor: pointer;
        font-size: 2em;
      }

      button:hover {
        background-color: #EF3C37;
      }

      button:active {
        top: 2px;
      }

      #controls {
        position: relative;
      }

      #stop {
        position: absolute;
        right: 0px;
        bottom: 2px;
      }

      q {
        position: absolute !important;
        clip: rect(1px, 1px, 1px, 1px);
      }

      aside {
        height: 45px;
      }

      #transcript {
        float: left;
        font-size: .8em;
        cursor: pointer;
      }

      #attribution {
        opacity: .5;
        width: 90px;
      }

    </style>
    <div id="container">
      <main>

        <h1>Push for Progress</h1>

        <span id="controls">
          <button type="button" id="button" on-click="play">Bernie</button>
          <span id="stop" hidden$="{{!playing}}" on-click="stop">stop</span>
        </span>

        <audio src$="{{track.stream_url}}?client_id=957c8fd36ac4a7b778e849943e09160f"
               on-ended="onEnd"
               on-playing="onPlay">
        </audio>

        <q></q>

        <aside hidden$="{{!track.title}}" id="details-one-line">{{track.title}}... <a target="_blank" href$="{{track.more}}">more</a></aside>

      </main>

      <footer>
        <span hidden$="{{!track.title}}" id="transcript" role="button" class="link" on-click="showTranscript">Transcript</span>
        <a target="_blank" href="https://soundcloud.com/daniel-gleckler/sets/test-sounds"><img src="img/sc-light.png" id="attribution" /></a>
      </footer>

    </div>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'bernie-button',

      properties: {
        captions: {
          type: Boolean,
          value: true,
          notify: true
        },
        plays: {
          type: Number,
          value: 0,
          notify: true
        },
        playing: {
          type: Boolean,
          value: false,
          notify: true
        },
        track: {
          type: Object,
          value: {},
          notify: true
        }
      },

      ready: function() {

        var self = this;
        var oReq = new XMLHttpRequest();
        oReq.addEventListener("load", function() {
          self.tracks = JSON.parse(this.responseText);
        });
        oReq.open("GET", "http://api.soundcloud.com/users/daniel-gleckler/tracks?client_id=957c8fd36ac4a7b778e849943e09160f");
        oReq.send();

      },

      play: function() {
        // how many plays for this loop?
        var loopPlays = this.plays%this.tracks.length;

        // grab a random track that hasn't yet been played
        var idx = Math.floor(Math.random() * (this.tracks.length-1-loopPlays));

        // move it to the end
        var track = this.tracks.splice(idx,1)[0];

        if (!("transcript" in track)) {
          var split = track.description.split('\n\n');
          track.transcript = split[0];
          track.more = split[1];
        }

        this.tracks.push(track);
        this.track = track;

        this.querySelector('audio').play();
        this.plays++;
      },

      onPlay: function() {
        this.playing = true;
      },

      onEnd: function() {
        this.playing = false;
      },

      stop: function() {
        this.querySelector('audio').pause();
        this.playing = false;
      },

      showTranscript: function() {
        alert(this.track.transcript);
      }

    });
  })();
  </script>
</dom-module>
